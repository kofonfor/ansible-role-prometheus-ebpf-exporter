- name: checkout ebpf_exporter
  git: repo=https://github.com/cloudflare/ebpf_exporter.git dest=/root/ebpf_exporter version=cf86dccfd98920db743e3d39b8bcbc6c5b7031aa

- name: install linux-headers-{{ ansible_kernel }}
  apt: name="linux-headers-{{ ansible_kernel }}"

- name: make ebpf_exporter
  shell: cd /root/ebpf_exporter && make creates=/root/ebpf_exporter/release/ebpf_exporter-1.2.2-0-cf86dccf.tar.gz

- name: download ebpf_exporter
  copy: remote_src=yes src=/root/ebpf_exporter/release/ebpf_exporter-1.2.2-0-cf86dccf.tar.gz dest=/root/ebpf_exporter.tar.gz

- name: unpack ebpf_exporter
  unarchive: copy=no src="/root/ebpf_exporter.tar.gz" dest=/opt

- name: create a link
  file: src=/opt/ebpf_exporter-1.2.2-0-cf86dccf/ebpf_exporter dest=/opt/ebpf_exporter state=link

- name: put /etc/ebpf_exporter_config.yaml
  template: src=ebpf_exporter_config.yaml dest=/etc/ebpf_exporter_config.yaml backup=yes
